<!doctype html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Are We Async Yet?</title>
    <script src="moment.min.js"></script>
    <script src="Chart.min.js"></script>
    <script src="chartjs-plugin-zoom.min.js"></script>
    <style>
        canvas {
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
        }

        div {
            width: 75%;
            margin-left: auto;
            margin-right: auto;
            padding-bottom: 2em;
        }
    </style>
</head>

<body>
    <div>
        <canvas id="canvas"></canvas>
    </div>

    <div>
        Synapse has traditionally used <a href="https://twistedmatrix.com/documents/current/api/twisted.internet.defer.html#inlineCallbacks"><code>inlineCallbacks</code></a>
        to have readable asynchronous code. Now that only Python 3 is supported, native async / await syntax can be used.
        This helps identify where performance is going (and helps find errors) due to giving saner stack traces.
    </div>

    <div>
        You can drag to zoom to a portion of the graph above. <button onclick="resetZoom();">Click to Reset Zoom</button>
    </div>

    <script>
        var config = {
            type: 'line',
            options: {
                responsive: true,
                title: {
                    display: true,
                    text: 'Are We Async Yet?'
                },
                tooltips: {
                    mode: 'index',
                },
                hover: {
                    mode: 'index'
                },
                scales: {
                    xAxes: [{
                        type: 'time',
                        time: {
                            "unit": "month",
                        },
                        distribution: 'series',
                        scaleLabel: {
                            display: true,
                            labelString: 'Date'
                        }
                    }],
                    yAxes: [{
                        stacked: true,
                        scaleLabel: {
                            display: true,
                            labelString: 'Count'
                        }
                    }]
                },
                plugins: {
                    zoom: {
                        zoom: {
                            enabled: true,
                            drag: true,
                            mode: 'x',
                            speed: 0.05
                        }
                    }
                }
            }
        };

        fetch("results.json").then(response => response.json()).then(data => {
            // Generate the data points from the raw data.
            let labels = [];
            let inlineCallbacks = [];
            let asyncDefs = [];

            for (let d of data.reverse()) {
                labels.push(d[1]);
                inlineCallbacks.push(d[2][0]);
                asyncDefs.push(d[3][0]);
            }

            // Finish up the config.
            config.data = {
                labels: labels,
                datasets: [
                    {
                        label: 'inlineCallbacks or cachedInlineCallbacks',
                        borderColor: "rgb(255, 99, 132)",  // Red
                        backgroundColor: "rgb(255, 99, 132)",
                        data: inlineCallbacks,
                    }, {
                        label: 'async',
                        borderColor: "rgb(54, 162, 235)",  // Blue
                        backgroundColor: "rgb(54, 162, 235)",
                        data: asyncDefs,
                    },
                ]
            };

            // Render the graph.
            let ctx = document.getElementById('canvas').getContext('2d');

            window.chart = new Chart(ctx, config);
        });

        function resetZoom() {
            window.chart.resetZoom();
        }
    </script>
</body>

</html>
